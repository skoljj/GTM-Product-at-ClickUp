<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Module 7 — Agent Layer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#020408;overflow:hidden;font-family:'SF Pro Display',system-ui,-apple-system,sans-serif;color:#c8d6e5}
canvas{position:fixed;top:0;left:0;z-index:0}
#hud{position:fixed;top:16px;left:16px;z-index:100;pointer-events:none}
#hud h1{font-size:11px;color:#f4a623;font-weight:300;letter-spacing:.15em;text-transform:uppercase;opacity:.9}
#hud .sub{font-size:9px;color:#445566;margin-top:3px;letter-spacing:.08em}
#hud .title{font-size:28px;font-weight:200;letter-spacing:.04em;margin-top:8px;color:#f4a623}
#hint{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:100;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:rgba(100,130,160,.5);pointer-events:none;transition:opacity .8s}
#back{position:fixed;bottom:24px;right:24px;z-index:100;background:rgba(8,12,24,.85);border:1px solid rgba(244,166,35,.2);color:#f4a623;padding:6px 14px;border-radius:3px;cursor:pointer;font-size:9px;letter-spacing:.1em;text-transform:uppercase;text-decoration:none;backdrop-filter:blur(8px)}
#back:hover{border-color:rgba(244,166,35,.5)}
</style>
</head>
<body>
<div id="hud">
  <h1>Capability Architecture · Module 7</h1>
  <div class="sub">Drag to orbit · Scroll to zoom</div>
  <div class="title">AGENT LAYER</div>
</div>
<div id="hint">DRAG TO ORBIT 360° · SCROLL TO ZOOM</div>
<a id="back" href="../product_design_concept1.html">← Full Diagram</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x020408,0.0003);
const camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.1,2500);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.15;
document.body.appendChild(renderer.domElement);

let drag=false,pM={x:0,y:0};
let sph={theta:0.6,phi:0.75,r:120};
const lookTarget=new THREE.Vector3(0,0,0);
function camUp(){
  camera.position.x=lookTarget.x+sph.r*Math.sin(sph.phi)*Math.sin(sph.theta);
  camera.position.y=lookTarget.y+sph.r*Math.cos(sph.phi);
  camera.position.z=lookTarget.z+sph.r*Math.sin(sph.phi)*Math.cos(sph.theta);
  camera.lookAt(lookTarget);
}
camUp();
renderer.domElement.addEventListener('pointerdown',e=>{drag=true;pM={x:e.clientX,y:e.clientY}});
renderer.domElement.addEventListener('pointermove',e=>{if(!drag)return;sph.theta-=(e.clientX-pM.x)*0.005;sph.phi=Math.max(0.1,Math.min(2.9,sph.phi+(e.clientY-pM.y)*0.005));pM={x:e.clientX,y:e.clientY};camUp()});
renderer.domElement.addEventListener('pointerup',()=>drag=false);
renderer.domElement.addEventListener('pointerleave',()=>drag=false);
renderer.domElement.addEventListener('wheel',e=>{e.preventDefault();sph.r=Math.max(40,Math.min(300,sph.r+e.deltaY*0.2));camUp()},{passive:false});

scene.add(new THREE.AmbientLight(0x223344,0.5));
[[0xf4a623,2.0,[0,20,0]],[0x00e5ff,1.5,[-30,10,0]],[0x818cf8,1.2,[30,10,0]],[0xff6b9d,0.8,[0,5,30]],[0x34d399,0.8,[0,5,-30]]]
.forEach(([c,i,p])=>{const pl=new THREE.PointLight(c,i,300);pl.position.set(...p);scene.add(pl)});

const starGeo=new THREE.BufferGeometry();const sP=new Float32Array(5000*3);
for(let i=0;i<5000;i++){const r=400+Math.random()*600,th=Math.random()*Math.PI*2,ph=Math.acos(2*Math.random()-1);
sP[i*3]=r*Math.sin(ph)*Math.cos(th);sP[i*3+1]=r*Math.sin(ph)*Math.sin(th);sP[i*3+2]=r*Math.cos(ph)}
starGeo.setAttribute('position',new THREE.BufferAttribute(sP,3));
scene.add(new THREE.Points(starGeo,new THREE.PointsMaterial({color:0x5577aa,size:0.3,transparent:true,opacity:0.4})));

// ═══ AGENT LAYER ═══
const QCOL=[new THREE.Color(0x00e5a0),new THREE.Color(0x6366f1),new THREE.Color(0xf4a623),new THREE.Color(0xe63946)];
const DISTRICTS=[
  {name:'COMMERCIAL',bldgs:17,ics:102,color:0x00e5ff},
  {name:'ENTERPRISE',bldgs:9,ics:54,color:0x818cf8},
  {name:'PARTNERSHIPS',bldgs:3,ics:18,color:0xc77dff},
  {name:'POST SALES',bldgs:3,ics:18,color:0xff6b9d},
  {name:'XDR',bldgs:3,ics:18,color:0x34d399},
  {name:'OPERATIONS',bldgs:3,ics:18,color:0xf4a623},
];
const AGENT_Y=0,AGENT_W=160,AGENT_D=110;const tileGap=2;
const allAntennas=[];

// Base platform
scene.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(AGENT_W,0.4,AGENT_D),new THREE.MeshPhysicalMaterial({color:0x060910,metalness:0.92,roughness:0.06,clearcoat:0.8}));m.position.y=AGENT_Y;return m})());
scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(AGENT_W,0.4,AGENT_D)),new THREE.LineBasicMaterial({color:0xf4a623,transparent:true,opacity:0.2}));m.position.y=AGENT_Y;return m})());
scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(AGENT_W+1.5,0.1,AGENT_D+1.5)),new THREE.LineBasicMaterial({color:0xf4a623,transparent:true,opacity:0.08}));m.position.y=AGENT_Y+0.05;return m})());
scene.add((()=>{const g=new THREE.GridHelper(AGENT_W-4,100,0x0a1218,0x060b10);g.position.y=AGENT_Y+0.22;return g})());

// Main label
(()=>{const c=document.createElement('canvas');c.width=512;c.height=64;const x=c.getContext('2d');
x.font='bold 28px monospace';x.fillStyle='#f4a623';x.globalAlpha=0.5;x.textAlign='center';x.fillText('AGENT LAYER',256,32);
x.font='400 16px monospace';x.globalAlpha=0.3;x.fillText('6 Activity Tiles | Execution Universe',256,54);
const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(c),transparent:true}));
s.position.set(0,AGENT_Y-6,0);s.scale.set(30,3.8,1);scene.add(s)})();

const TILE_DEFS=[
  {di:0,col:0,row:0,wFrac:0.42,activity:800,speed:1.4},{di:1,col:1,row:0,wFrac:0.32,activity:500,speed:1.1},
  {di:2,col:2,row:0,wFrac:0.22,activity:250,speed:0.8},{di:4,col:0,row:1,wFrac:0.28,activity:250,speed:0.8},
  {di:3,col:1,row:1,wFrac:0.28,activity:250,speed:0.8},{di:5,col:2,row:1,wFrac:0.40,activity:1400,speed:2.0},
];
const usableW=AGENT_W-8,rowH=(AGENT_D-6-tileGap)/2;
const activityCubes=[],tileCenters={};

TILE_DEFS.forEach(tile=>{const d=DISTRICTS[tile.di];
  const rowTiles=TILE_DEFS.filter(t=>t.row===tile.row);const totalFrac=rowTiles.reduce((s,t)=>s+t.wFrac,0);
  let xOff=-usableW/2;for(const rt of rowTiles){if(rt===tile)break;xOff+=(rt.wFrac/totalFrac)*usableW+tileGap}
  const tW=(tile.wFrac/totalFrac)*usableW-tileGap;const tD=rowH-tileGap;
  const tCX=xOff+tW/2;const tCZ=tile.row===0?-(rowH+tileGap)/2:(rowH+tileGap)/2;
  tileCenters[tile.di]={x:tCX,z:tCZ,w:tW,d:tD};

  const tileFill=new THREE.Mesh(new THREE.PlaneGeometry(tW,tD),new THREE.MeshBasicMaterial({color:d.color,transparent:true,opacity:0.018,side:THREE.DoubleSide}));
  tileFill.rotation.x=-Math.PI/2;tileFill.position.set(tCX,AGENT_Y+0.23,tCZ);scene.add(tileFill);
  scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(tW,0.04,tD)),new THREE.LineBasicMaterial({color:d.color,transparent:true,opacity:0.25}));m.position.set(tCX,AGENT_Y+0.24,tCZ);return m})());

  const sH=1.5,sT=0.2;const sMat=new THREE.MeshBasicMaterial({color:d.color,transparent:true,opacity:0.12});
  const sEMat=new THREE.LineBasicMaterial({color:d.color,transparent:true,opacity:0.45});
  const wLR=new THREE.BoxGeometry(sT,sH,tD);const wFB=new THREE.BoxGeometry(tW,sH,sT);
  [-1,1].forEach(s=>{const w=new THREE.Mesh(wLR,sMat);w.position.set(tCX+s*tW/2,AGENT_Y+sH/2,tCZ);scene.add(w);scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(wLR),sEMat);m.position.copy(w.position);return m})())});
  [-1,1].forEach(s=>{const w=new THREE.Mesh(wFB,sMat);w.position.set(tCX,AGENT_Y+sH/2,tCZ+s*tD/2);scene.add(w);scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(wFB),sEMat);m.position.copy(w.position);return m})())});

  [[-tW/2,-tD/2],[tW/2,-tD/2],[-tW/2,tD/2],[tW/2,tD/2]].forEach(([cx,cz])=>{
    const b=new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8),new THREE.MeshBasicMaterial({color:d.color,transparent:true,opacity:0.5}));
    b.position.set(tCX+cx,AGENT_Y+sH+0.3,tCZ+cz);b.userData={ph:Math.random()*Math.PI*2};scene.add(b);allAntennas.push(b)});

  const lC=document.createElement('canvas');lC.width=512;lC.height=80;const lX=lC.getContext('2d');
  lX.font='bold 22px monospace';lX.fillStyle='#'+d.color.toString(16).padStart(6,'0');lX.globalAlpha=0.55;lX.textAlign='center';lX.fillText(d.name,256,32);
  lX.font='400 16px monospace';lX.globalAlpha=0.3;lX.fillText(tile.activity+' agents',256,58);
  const lS=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(lC),transparent:true,opacity:0.85}));
  lS.position.set(tCX,AGENT_Y+sH+1.8,tCZ);lS.scale.set(tW*0.6,tW*0.09,1);scene.add(lS);

  const cubeSize=Math.min(tW,tD)*0.55;const cubeH=cubeSize*(0.6+tile.speed*0.25);const cubeCY=AGENT_Y+0.3+cubeH/2;
  scene.add((()=>{const m=new THREE.Mesh(new THREE.BoxGeometry(cubeSize,cubeH,cubeSize),new THREE.MeshPhysicalMaterial({color:d.color,transparent:true,opacity:0.03,metalness:0.3,roughness:0.2,side:THREE.DoubleSide}));m.position.set(tCX,cubeCY,tCZ);return m})());
  scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(cubeSize,cubeH,cubeSize)),new THREE.LineBasicMaterial({color:d.color,transparent:true,opacity:0.35}));m.position.set(tCX,cubeCY,tCZ);return m})());
  scene.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(cubeSize*0.6,cubeH*0.6,cubeSize*0.6)),new THREE.LineBasicMaterial({color:d.color,transparent:true,opacity:0.15}));m.position.set(tCX,cubeCY,tCZ);return m})());

  const pCount=tile.activity;const pGeo=new THREE.BufferGeometry();const pPos=new Float32Array(pCount*3);
  for(let i=0;i<pCount;i++){pPos[i*3]=tCX+(Math.random()-0.5)*cubeSize*0.9;pPos[i*3+1]=AGENT_Y+0.3+Math.random()*cubeH;pPos[i*3+2]=tCZ+(Math.random()-0.5)*cubeSize*0.9}
  pGeo.setAttribute('position',new THREE.BufferAttribute(pPos,3));
  const pSize=pCount>1000?0.1:pCount>500?0.15:0.2;
  const pMat=new THREE.PointsMaterial({color:d.color,size:pSize,transparent:true,opacity:0.6,blending:THREE.AdditiveBlending});
  const particles=new THREE.Points(pGeo,pMat);scene.add(particles);
  const coreGlow=new THREE.Mesh(new THREE.SphereGeometry(cubeSize*0.2,12,12),new THREE.MeshBasicMaterial({color:d.color,transparent:true,opacity:0.05+tile.speed*0.06}));
  coreGlow.position.set(tCX,cubeCY,tCZ);scene.add(coreGlow);
  activityCubes.push({particles,basePos:pPos.slice(),speed:tile.speed,cx:tCX,cy:cubeCY,cz:tCZ,cubeSize,cubeH,coreGlow,pMat});
});

// Super agents on south walls
const superAgentNames=['SCOUT','ANALYST','BUILDER','ADVISOR','ORCHESTRATOR'];
const agentChars=[];
TILE_DEFS.forEach(tile=>{
  const d=DISTRICTS[tile.di];const tc=tileCenters[tile.di];if(!tc)return;
  const col=d.color;
  const sAgentZ=tc.z+tc.d/2-2.2,sAgentCount=5;
  const sAgentSpacing=Math.min((tc.w-4)/4,5.5);
  const sAgentStartX=tc.x-2*sAgentSpacing;
  for(let i=0;i<sAgentCount;i++){
    const ax=sAgentStartX+i*sAgentSpacing,az=sAgentZ;
    const charG=new THREE.Group();charG.position.set(ax,AGENT_Y+0.3,az);
    const bodyH=4.2,bodyR=0.7;
    const torso=new THREE.Mesh(new THREE.CylinderGeometry(bodyR,bodyR*0.75,bodyH*0.5,12),new THREE.MeshPhysicalMaterial({color:col,transparent:true,opacity:0.14,metalness:0.6,roughness:0.25}));
    torso.position.y=bodyH*0.35;charG.add(torso);
    charG.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.CylinderGeometry(bodyR,bodyR*0.75,bodyH*0.5,12)),new THREE.LineBasicMaterial({color:col,transparent:true,opacity:0.45}));m.position.y=bodyH*0.35;return m})());
    [-1,1].forEach(side=>{const shoulder=new THREE.Mesh(new THREE.BoxGeometry(0.35,0.15,0.5),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.2}));shoulder.position.set(side*(bodyR+0.15),bodyH*0.5,0);charG.add(shoulder)});
    const head=new THREE.Mesh(new THREE.SphereGeometry(0.5,12,12),new THREE.MeshPhysicalMaterial({color:col,transparent:true,opacity:0.16,metalness:0.7,roughness:0.2}));
    head.position.y=bodyH*0.67;charG.add(head);
    charG.add((()=>{const m=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.SphereGeometry(0.5,8,8)),new THREE.LineBasicMaterial({color:col,transparent:true,opacity:0.5}));m.position.y=bodyH*0.67;return m})());
    const visor=new THREE.Mesh(new THREE.BoxGeometry(0.85,0.1,0.12),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.8}));
    visor.position.set(0,bodyH*0.69,0.5+0.02);charG.add(visor);
    const pad=new THREE.Mesh(new THREE.CylinderGeometry(1.1,1.1,0.1,16),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.1}));
    pad.position.y=0.05;charG.add(pad);
    const pulseRing=new THREE.Mesh(new THREE.RingGeometry(1.3,1.5,24),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.12,side:THREE.DoubleSide}));
    pulseRing.rotation.x=-Math.PI/2;pulseRing.position.y=0.07;pulseRing.userData={ph:i*1.2+tile.di*0.5};charG.add(pulseRing);
    const beacon=new THREE.Mesh(new THREE.SphereGeometry(0.09,6,6),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.85}));
    beacon.position.y=bodyH*0.67+0.5+0.5;beacon.userData={ph:i*0.9+tile.di*0.7};charG.add(beacon);allAntennas.push(beacon);
    const lC=document.createElement('canvas');lC.width=256;lC.height=48;const lX=lC.getContext('2d');
    lX.font='bold 14px monospace';lX.fillStyle='#'+col.toString(16).padStart(6,'0');lX.globalAlpha=0.55;lX.textAlign='center';lX.fillText(superAgentNames[i%5],128,20);
    const lS=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(lC),transparent:true}));
    lS.position.set(0,bodyH*0.67+0.5+1.5,0);lS.scale.set(4,0.9,1);charG.add(lS);
    scene.add(charG);agentChars.push({group:charG,pulseRing,beacon,baseY:AGENT_Y+0.3,col});
  }
});

// ═══ ANIMATE ═══
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);const t=clock.getElapsedTime();
  allAntennas.forEach(tip=>{tip.material.opacity=0.15+0.85*Math.abs(Math.sin(t*2.5+tip.userData.ph))});
  agentChars.forEach((ac,i)=>{
    ac.group.position.y=ac.baseY+Math.sin(t*0.8+i*1.1)*0.15;
    const ps=1+0.3*Math.sin(t*1.2+i*0.8);
    ac.pulseRing.scale.set(ps,ps,1);
    ac.pulseRing.material.opacity=0.05+0.08*Math.abs(Math.sin(t*1.5+i));
    ac.group.rotation.y=Math.sin(t*0.3+i*1.5)*0.15;
  });
  activityCubes.forEach(ac=>{const pos=ac.particles.geometry.attributes.position.array;const base=ac.basePos;const n=pos.length/3;const spd=ac.speed;
  for(let i=0;i<n;i++){pos[i*3]=base[i*3]+Math.sin(t*spd*1.1+i*0.03)*(0.3*spd);pos[i*3+1]=base[i*3+1]+Math.sin(t*spd*0.8+i*0.05)*(0.5*spd);pos[i*3+2]=base[i*3+2]+Math.cos(t*spd*0.9+i*0.04)*(0.3*spd)}
  ac.particles.geometry.attributes.position.needsUpdate=true;ac.pMat.opacity=0.4+0.25*Math.sin(t*spd*0.3);
  const gs=0.8+0.4*Math.sin(t*spd*0.5);ac.coreGlow.scale.set(gs,gs,gs);ac.coreGlow.material.opacity=(0.04+ac.speed*0.04)*(0.7+0.3*Math.sin(t*spd))});
  renderer.render(scene,camera);
}
animate();
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
setTimeout(()=>{document.getElementById('hint').style.opacity='0'},5000);
</script>
</body>
</html>
